<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PowerPix</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #0F172A;
            --card-bg: #1E293B;
            --primary: #22C55E;
            --primary-hover: #16A34A;
            --accent: #E11D48;
            --text: #F8FAFC;
            --text-muted: #94A3B8;
            --border: #334155;
            --error: #EF4444;
            --success: #22C55E;
            --warning: #F59E0B;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding-bottom: 100px;
            user-select: none;
        }

        /* STEPPER */
        .stepper {
            background: var(--card-bg);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 60%;
            width: 80%;
            height: 2px;
            background: var(--border);
            z-index: 0;
        }

        .step:last-child::after { display: none; }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
        }

        .step.completed .step-circle {
            background: var(--success);
            color: white;
        }

        .step-label {
            font-size: 0.7rem;
            margin-top: 8px;
            color: var(--text-muted);
            text-align: center;
        }

        .step.active .step-label { color: var(--primary); font-weight: 600; }

        /* SCREENS */
        .screen { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .screen.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* HEADER */
        .header {
            position: sticky;
            top: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .balance-container { display: flex; flex-direction: column; }
        .balance-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .balance-value { font-size: 1.25rem; font-weight: 800; color: var(--primary); }

        .btn-deposit {
            background: linear-gradient(135deg, var(--primary), #166534);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
            transition: transform 0.1s;
        }
        .btn-deposit:active { transform: scale(0.95); }

        /* FORM STYLES */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
        }

        .form-group label .required { color: var(--error); }

        .form-input {
            width: 100%;
            padding: 14px;
            background: var(--bg-color);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 1rem;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1); }

        .form-input.error { border-color: var(--error); }
        .form-input.success { border-color: var(--success); }

        .form-help {
            font-size: 0.8rem;
            margin-top: 6px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-error {
            font-size: 0.8rem;
            margin-top: 6px;
            color: var(--error);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-success {
            font-size: 0.8rem;
            margin-top: 6px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* GAME SECTION */
        .game-header {
            background: var(--card-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-display {
            display: flex;
            flex-direction: column;
        }

        .price-label { font-size: 0.75rem; color: var(--text-muted); }
        .price-value { font-size: 1.5rem; font-weight: 800; color: var(--primary); }

        .btn-random {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
            transition: transform 0.1s;
        }

        .btn-random:active { transform: scale(0.95); }

        .random-help {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            margin: 8px 0 20px;
            padding: 0 20px;
        }

        .game-section { padding: 20px; }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .counter {
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--border);
        }

        .counter.full { background: var(--primary); color: #000; }

        .grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 30px;
        }

        .ball {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 50%;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ball.white.selected {
            background: var(--text);
            color: var(--bg-color);
            border-color: var(--text);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .ball.red.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(225, 29, 72, 0.4);
        }

        /* FOOTER */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            z-index: 90;
        }

        .footer-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .summary-item { font-size: 0.85rem; }
        .summary-label { color: var(--text-muted); }
        .summary-value { font-weight: 700; color: var(--text); }

        .btn-action {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--border);
            color: var(--text-muted);
        }

        .btn-action.ready {
            background: linear-gradient(135deg, var(--primary), #15803d);
            color: white;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
        }

        .btn-action:active { transform: scale(0.98); }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: flex-end;
            animation: fadeIn 0.2s;
        }

        .modal-overlay.open { display: flex; }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 500px;
            border-radius: 20px 20px 0 0;
            padding: 25px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }

        .btn-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .deposit-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .chip {
            background: var(--bg-color);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px 5px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chip:active, .chip.selected {
            border-color: var(--primary);
            background: rgba(34, 197, 94, 0.1);
            color: var(--primary);
        }

        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); }
        .custom-input {
            width: 100%;
            padding: 16px;
            background: var(--bg-color);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 1.2rem;
            font-weight: 700;
            outline: none;
        }
        .custom-input:focus { border-color: var(--primary); }

        .pix-area {
            display: none;
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .pix-code {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            word-break: break-all;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 15px 0;
            border: 1px dashed var(--border);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-pending { background: rgba(253, 186, 116, 0.2); color: #fb923c; }
        .status-success { background: rgba(34, 197, 94, 0.2); color: var(--primary); }

        .loader {
            width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* BUTTONS */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), #15803d);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text);
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-secondary:active { transform: scale(0.98); }

        .btn-danger {
            width: 100%;
            padding: 14px;
            background: var(--error);
            border: 2px solid var(--error);
            color: white;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-danger:active { transform: scale(0.98); }

        /* TABS */
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .info-value {
            color: var(--text);
            font-weight: 600;
            text-align: right;
        }

        .bet-card, .transaction-card, .result-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-won {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .status-lost {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .status-pending {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-muted);
        }
    </style>
</head>
<body>

    <!-- STEPPER (oculto na tela de login) -->
    <div class="stepper" id="stepper" style="display: none;">
        <div class="step active" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-label">Dados Pessoais</div>
        </div>
        <div class="step" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Pagamento</div>
        </div>
        <div class="step" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Jogar</div>
        </div>
    </div>

    <!-- SCREEN 0: LOGIN -->
    <div class="screen" id="screen-0">
        <div style="text-align: center; margin-bottom: 40px; padding-top: 40px;">
            <div style="font-size: 3rem; margin-bottom: 15px;">‚ö°</div>
            <h1 style="font-size: 1.8rem; margin: 0 0 10px; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">PowerPix</h1>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Fa√ßa login para continuar</p>
        </div>

        <form id="form-login" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>CPF <span class="required">*</span></label>
                <input type="text" class="form-input" id="login-cpf" required placeholder="000.000.000-00" maxlength="14">
                <div class="form-help">
                    <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                    Digite seu CPF cadastrado
                </div>
                <div class="form-error" id="login-error" style="display: none;">
                    <i data-lucide="alert-circle" style="width: 14px; height: 14px;"></i>
                    <span id="login-error-text">CPF ou telefone inv√°lidos</span>
                </div>
        </div>

            <div class="form-group">
                <label>Telefone <span class="required">*</span></label>
                <input type="tel" class="form-input" id="login-telefone" required placeholder="(00) 00000-0000" maxlength="15">
                <div class="form-help">
                    <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                    Digite o telefone cadastrado
                </div>
        </div>

            <button type="submit" class="btn-primary">
                Entrar
                <i data-lucide="log-in" style="width: 20px; height: 20px;"></i>
            </button>

            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px;">
                    N√£o tem uma conta?
                </p>
                <button type="button" class="btn-secondary" onclick="showScreen(1)">
                    Criar Nova Conta
                </button>
            </div>
        </form>
    </div>

    <!-- HEADER -->
    <header class="header" id="game-header" style="display: none;">
        <div class="balance-container">
            <span class="balance-label">Saldo Dispon√≠vel</span>
            <span class="balance-value" id="user-balance">R$ 0,00</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn-deposit" onclick="openDepositModal()">
                <i data-lucide="plus-circle" style="width: 18px; height: 18px;"></i>
                DEPOSITAR
            </button>
            <button class="btn-deposit" onclick="showScreen(4)" style="background: var(--card-bg); box-shadow: none;">
                <i data-lucide="user" style="width: 18px; height: 18px;"></i>
            </button>
        </div>
    </header>

    <!-- SCREEN 1: DADOS PESSOAIS -->
    <div class="screen" id="screen-1">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="font-size: 1.5rem; margin: 0 0 10px;">Bem-vindo ao PowerPix! üéÆ</h1>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Complete seu cadastro para come√ßar</p>
            <div style="margin-top: 15px;">
                <button type="button" class="btn-secondary" onclick="showScreen(0)" style="padding: 8px 16px; font-size: 0.85rem;">
                    J√° tenho conta - Fazer Login
                </button>
            </div>
        </div>

        <form id="form-personal" onsubmit="nextStep(event, 2)">
            <div class="form-group">
                <label>Nome Completo <span class="required">*</span></label>
                <input type="text" class="form-input" id="nome" required placeholder="Seu nome completo">
                <div class="form-help">
                    <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                    Nome completo como consta no documento
                </div>
            </div>

            <div class="form-group">
                <label>CPF <span class="required">*</span></label>
                <input type="text" class="form-input" id="cpf" required placeholder="000.000.000-00" maxlength="14">
                <div class="form-help" id="cpf-help">
                    <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                    CPF v√°lido (11 d√≠gitos)
                </div>
                <div class="form-error" id="cpf-error" style="display: none;">
                    <i data-lucide="alert-circle" style="width: 14px; height: 14px;"></i>
                    <span>CPF inv√°lido</span>
                </div>
                <div class="form-success" id="cpf-success" style="display: none;">
                    <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
                    <span>CPF v√°lido</span>
                </div>
            </div>

            <div class="form-group">
                <label>Telefone <span class="required">*</span></label>
                <input type="tel" class="form-input" id="telefone" required placeholder="(00) 00000-0000" maxlength="15">
                <div class="form-help">
                    <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                    N√∫mero para contato
                </div>
            </div>

            <div class="form-group">
                <label>Cidade <span style="color: var(--text-muted); font-weight: normal;">(opcional)</span></label>
                <input type="text" class="form-input" id="cidade" placeholder="Sua cidade">
            </div>

            <div class="form-group">
                <label>Estado (UF) <span style="color: var(--text-muted); font-weight: normal;">(opcional)</span></label>
                <select class="form-input" id="estado">
                    <option value="">Selecione...</option>
                    <option value="AC">AC - Acre</option>
                    <option value="AL">AL - Alagoas</option>
                    <option value="AP">AP - Amap√°</option>
                    <option value="AM">AM - Amazonas</option>
                    <option value="BA">BA - Bahia</option>
                    <option value="CE">CE - Cear√°</option>
                    <option value="DF">DF - Distrito Federal</option>
                    <option value="ES">ES - Esp√≠rito Santo</option>
                    <option value="GO">GO - Goi√°s</option>
                    <option value="MA">MA - Maranh√£o</option>
                    <option value="MT">MT - Mato Grosso</option>
                    <option value="MS">MS - Mato Grosso do Sul</option>
                    <option value="MG">MG - Minas Gerais</option>
                    <option value="PA">PA - Par√°</option>
                    <option value="PB">PB - Para√≠ba</option>
                    <option value="PR">PR - Paran√°</option>
                    <option value="PE">PE - Pernambuco</option>
                    <option value="PI">PI - Piau√≠</option>
                    <option value="RJ">RJ - Rio de Janeiro</option>
                    <option value="RN">RN - Rio Grande do Norte</option>
                    <option value="RS">RS - Rio Grande do Sul</option>
                    <option value="RO">RO - Rond√¥nia</option>
                    <option value="RR">RR - Roraima</option>
                    <option value="SC">SC - Santa Catarina</option>
                    <option value="SP">SP - S√£o Paulo</option>
                    <option value="SE">SE - Sergipe</option>
                    <option value="TO">TO - Tocantins</option>
                </select>
            </div>

            <button type="submit" class="btn-primary">
                Continuar
                <i data-lucide="arrow-right" style="width: 20px; height: 20px;"></i>
            </button>
        </form>
        
        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px;">
                J√° tem uma conta?
            </p>
            <button type="button" class="btn-secondary" onclick="showScreen(0)">
                Fazer Login
            </button>
        </div>
    </div>

    <!-- SCREEN 2: DADOS DE PAGAMENTO -->
    <div class="screen" id="screen-2">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="font-size: 1.3rem; margin: 0 0 10px;">Chave Pix</h2>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Onde voc√™ receber√° seus pr√™mios</p>
        </div>

        <form id="form-payment" onsubmit="nextStep(event, 3)">
            <div class="form-group">
                <label>Chave Pix <span class="required">*</span></label>
                <input type="text" class="form-input" id="pix" required placeholder="CPF, e-mail, telefone ou chave aleat√≥ria">
                <div class="form-help" id="pix-help">
                    <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                    CPF, e-mail, telefone ou chave aleat√≥ria v√°lida
                </div>
                <div class="form-error" id="pix-error" style="display: none;">
                    <i data-lucide="alert-circle" style="width: 14px; height: 14px;"></i>
                    <span id="pix-error-text">Chave Pix inv√°lida</span>
                </div>
                <div class="form-success" id="pix-success" style="display: none;">
                    <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
                    <span>Chave Pix v√°lida</span>
                </div>
            </div>

            <button type="submit" class="btn-primary">
                Finalizar Cadastro
                <i data-lucide="check" style="width: 20px; height: 20px;"></i>
            </button>

            <button type="button" class="btn-secondary" onclick="prevStep(1)">
                Voltar
            </button>
        </form>
        
        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px;">
                J√° tem uma conta?
            </p>
            <button type="button" class="btn-secondary" onclick="showScreen(0)">
                Fazer Login
            </button>
        </div>
    </div>

    <!-- SCREEN 3: JOGAR -->
    <div class="screen" id="screen-3">
        <div class="game-header">
            <div class="price-display">
                <span class="price-label">Valor da Aposta</span>
                <span class="price-value" id="bet-price">R$ 5,00</span>
            </div>
        </div>

        <!-- Informa√ß√µes do Concurso -->
        <div id="concurso-info" style="background: var(--card-bg); margin: 20px; padding: 15px; border-radius: 12px; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="trophy" style="width: 18px; height: 18px; color: #F59E0B;"></i>
                    <span id="concurso-nome">Aguardando novo concurso</span>
                </h3>
                <span id="concurso-id" style="font-size: 0.75rem; color: var(--text-muted);"></span>
            </div>
            <div style="display: flex; justify-content: space-between; gap: 15px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 120px;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Pr√™mio Total</div>
                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary);" id="concurso-premio">R$ 0,00</div>
                </div>
                <div style="flex: 1; min-width: 120px;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Data do Sorteio</div>
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--text);" id="concurso-data">A definir</div>
                </div>
            </div>
        </div>

        <div style="padding: 20px;">
            <button class="btn-random" onclick="gerarSurpresinha()">
                <i data-lucide="shuffle" style="width: 20px; height: 20px;"></i>
                Escolher N√∫meros Aleat√≥rios
            </button>
            <p class="random-help">
                O sistema escolhe os n√∫meros automaticamente para voc√™
            </p>

            <div class="section-title">
                <span style="display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="circle" style="width: 16px; height: 16px;"></i>
                    N√∫meros (1-69)
                </span>
                <span id="counter-white" class="counter">0/20</span>
            </div>
            <div class="grid" id="grid-white"></div>

            <div class="section-title">
                <span style="display: flex; align-items: center; gap: 8px; color: var(--accent);">
                    <i data-lucide="circle-dot" style="width: 16px; height: 16px;"></i>
                    Powerball (1-26)
                </span>
                <span id="counter-red" class="counter">0/5</span>
            </div>
            <div class="grid" id="grid-red"></div>
        </div>
    </div>

    <!-- FOOTER (S√≥ aparece na tela de jogo) -->
    <footer class="footer" id="game-footer" style="display: none;">
        <div class="footer-summary">
            <div class="summary-item">
                <div class="summary-label">N√∫meros Selecionados</div>
                <div class="summary-value" id="summary-selected">0/25</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Valor da Aposta</div>
                <div class="summary-value" id="summary-price">R$ 0,00</div>
            </div>
        </div>
        <button id="btn-action" class="btn-action" onclick="submitBet()" disabled>
            Selecione os N√∫meros
        </button>
    </footer>

    <!-- MODAL DE DEP√ìSITO -->
    <div class="modal-overlay" id="deposit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i data-lucide="wallet" style="width: 24px; height: 24px;"></i>
                    Depositar via Pix
                </div>
                <button class="btn-close" onclick="closeDepositModal()">
                    <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                </button>
            </div>

            <div id="step-amount">
                <div class="input-group">
                    <label>Escolha um valor r√°pido:</label>
                    <div class="deposit-options">
                        <div class="chip" onclick="setAmount(5)">R$ 5</div>
                        <div class="chip" onclick="setAmount(10)">R$ 10</div>
                        <div class="chip" onclick="setAmount(20)">R$ 20</div>
                        <div class="chip" onclick="setAmount(35)">R$ 35</div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Ou digite outro valor (Min R$ 5,00):</label>
                    <input type="number" id="deposit-amount" class="custom-input" placeholder="0.00" inputmode="decimal">
                </div>

                <button class="btn-primary" onclick="generatePix()">
                    Gerar Pix
                    <i data-lucide="qrcode" style="width: 20px; height: 20px;"></i>
                </button>
            </div>

            <div id="step-pix" class="pix-area">
                <div class="status-badge status-pending" id="pix-status">
                    <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                    Aguardando Pagamento...
                </div>
                <p style="font-size: 0.9rem; opacity: 0.8; margin: 0;">Copie o c√≥digo abaixo e pague no seu banco:</p>
                
                <div class="pix-code" id="pix-copy-paste" onclick="copyPix()"></div>

                <button class="btn-primary" onclick="copyPix()">
                    <i data-lucide="copy" style="width: 20px; height: 20px;"></i>
                    Copiar C√≥digo
                </button>
            </div>
        </div>
    </div>

    <!-- SCREEN 4: PERFIL -->
    <div class="screen" id="screen-4">
        <div style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 style="font-size: 1.5rem; margin: 0;">Meu Perfil</h1>
                <button class="btn-secondary" onclick="showScreen(3)" style="padding: 8px 16px; font-size: 0.85rem;">
                    <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
                    Voltar
                </button>
            </div>

            <!-- Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border);">
                <button class="tab-btn active" onclick="switchTab('dados')" data-tab="dados">
                    <i data-lucide="user" style="width: 18px; height: 18px;"></i>
                    Dados
                </button>
                <button class="tab-btn" onclick="switchTab('apostas')" data-tab="apostas">
                    <i data-lucide="ticket" style="width: 18px; height: 18px;"></i>
                    Apostas
                </button>
                <button class="tab-btn" onclick="switchTab('transacoes')" data-tab="transacoes">
                    <i data-lucide="wallet" style="width: 18px; height: 18px;"></i>
                    Transa√ß√µes
                </button>
                <button class="tab-btn" onclick="switchTab('resultados')" data-tab="resultados">
                    <i data-lucide="award" style="width: 18px; height: 18px;"></i>
                    Resultados
                </button>
            </div>

            <!-- Tab Content: Dados -->
            <div id="tab-dados" class="tab-content active">
                <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px; font-size: 1.1rem;">Informa√ß√µes Pessoais</h3>
                    <div id="profile-data" style="display: grid; gap: 15px;">
                        <!-- Dados ser√£o preenchidos via JavaScript -->
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn-secondary" onclick="handleLogout()">
                        <i data-lucide="log-out" style="width: 18px; height: 18px;"></i>
                        Deslogar
                    </button>
                    <button class="btn-danger" onclick="openArchiveModal()" style="background: var(--error); border-color: var(--error);">
                        <i data-lucide="archive" style="width: 18px; height: 18px;"></i>
                        Arquivar Conta
                    </button>
                </div>
            </div>

            <!-- Tab Content: Apostas -->
            <div id="tab-apostas" class="tab-content">
                <div id="bets-list" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Lista ser√° preenchida via JavaScript -->
                </div>
            </div>

            <!-- Tab Content: Transa√ß√µes -->
            <div id="tab-transacoes" class="tab-content">
                <div id="transactions-list" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Lista ser√° preenchida via JavaScript -->
                </div>
            </div>

            <!-- Tab Content: Resultados -->
            <div id="tab-resultados" class="tab-content">
                <div id="results-list" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Lista ser√° preenchida via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE ARQUIVAR CONTA -->
    <div class="modal-overlay" id="archive-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i data-lucide="alert-triangle" style="width: 24px; height: 24px; color: var(--warning);"></i>
                    Arquivar Conta
                </div>
                <button class="btn-close" onclick="closeArchiveModal()">
                    <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                </button>
            </div>

            <div style="padding: 20px 0;">
                <p style="margin-bottom: 15px; line-height: 1.6;">
                    <strong>Aten√ß√£o!</strong> Sua conta ser√° desativada e poder√° ser reativada pelo administrador.
                </p>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
                    Todos os seus dados ser√£o mantidos, mas voc√™ n√£o poder√° fazer apostas at√© que a conta seja reativada.
                </p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-secondary" onclick="closeArchiveModal()" style="flex: 1;">
                        Cancelar
                    </button>
                    <button class="btn-danger" onclick="confirmArchive()" style="flex: 1; background: var(--error); border-color: var(--error);">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const tg = window.Telegram.WebApp;
        tg.expand();

        const state = {
            balance: 0,
            betPrice: 5.00,
            white: new Set(),
            red: new Set(),
            telegramId: tg.initDataUnsafe?.user?.id || 123456789,
            currentStep: 1,
            registered: false,
            pixInterval: null,
            concurso: {
                id: null,
                nome: 'Aguardando novo concurso',
                premio: 0.00,
                dataSorteio: null
            }
        };

        const LIMITS = { WHITE: 20, RED: 5 };

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Aplicar m√°scaras nos campos de login tamb√©m
            applyMasks();
            setupValidation();
            
            // Sempre mostrar tela de login primeiro (acesso via web)
            // Se tiver telegram_id v√°lido do Telegram, verificar cadastro automaticamente
            if (state.telegramId && state.telegramId !== 123456789) {
                // Est√° acessando pelo Telegram - verificar cadastro
                checkRegistration();
                fetchConfig();
            } else {
                // Acesso via web - sempre mostrar tela de login primeiro
                showScreen(0);
            }
        });

        // ==================== LOGIN ====================

        async function handleLogin(e) {
            e.preventDefault();
            
            const cpf = document.getElementById('login-cpf').value.trim();
            const telefone = document.getElementById('login-telefone').value.trim();
            
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;
            
            const errorEl = document.getElementById('login-error');
            errorEl.style.display = 'none';
            
            try {
                const res = await fetch(`${API_BASE}/api/player/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cpf, telefone })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    // Login bem-sucedido - usar telegram_id retornado
                    state.telegramId = data.telegram_id;
                    state.registered = true;
                    
                    if (data.cadastro_completo) {
                        // Cadastro completo - ir direto para jogo
                        showScreen(3);
                        fetchUserData();
                        fetchConfig();
                    } else {
                        // Cadastro incompleto - mostrar cadastro
                        showScreen(1);
                    }
                    
                    tg.showAlert('‚úÖ Login realizado com sucesso!');
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    // Erro no login
                    document.getElementById('login-error-text').textContent = data.message || 'CPF ou telefone inv√°lidos';
                    errorEl.style.display = 'flex';
                    tg.showAlert(`‚ùå ${data.message || 'Erro ao fazer login'}`);
                    tg.HapticFeedback.notificationOccurred('error');
                }
            } catch (e) {
                console.error("Erro ao fazer login", e);
                document.getElementById('login-error-text').textContent = 'Erro de conex√£o. Tente novamente.';
                errorEl.style.display = 'flex';
                tg.showAlert('‚ùå Erro de conex√£o');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                setTimeout(() => lucide.createIcons(), 100);
            }
        }

        // ==================== REGISTRATION CHECK ====================

        async function checkRegistration() {
            try {
                const res = await fetch(`${API_BASE}/api/player/check-registration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: state.telegramId })
                });
                const data = await res.json();
                
                if (data.cadastro_completo) {
                    state.registered = true;
                    showScreen(3);
                    fetchUserData();
            } else {
                    showScreen(1);
                }
            } catch (e) {
                console.error("Erro ao verificar cadastro", e);
                showScreen(1);
            }
        }

        // ==================== STEPPER ====================

        function showScreen(step) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${step}`).classList.add('active');
            
            // Esconder stepper na tela de login e perfil
            if (step === 0 || step === 4) {
                document.getElementById('stepper').style.display = 'none';
                document.getElementById('game-header').style.display = 'none';
                document.getElementById('game-footer').style.display = 'none';
                
                if (step === 4) {
                    // Carregar dados do perfil ao abrir
                    switchTab('dados');
                }
                } else {
                document.getElementById('stepper').style.display = 'flex';
                
                // Update stepper apenas para telas de cadastro (1 e 2)
                if (step === 1 || step === 2) {
                    document.querySelectorAll('.step').forEach((s, i) => {
                        s.classList.remove('active', 'completed');
                        if (i + 1 < step) s.classList.add('completed');
                        if (i + 1 === step) s.classList.add('active');
                    });
                    state.currentStep = step;
                }

                if (step === 3) {
                    document.getElementById('game-header').style.display = 'flex';
                    document.getElementById('game-footer').style.display = 'block';
                    if (!document.getElementById('grid-white').children.length) {
                        renderGrids();
                    }
                    fetchUserData();
                    fetchConfig(); // Buscar informa√ß√µes do concurso
                } else {
                    document.getElementById('game-header').style.display = 'none';
                    document.getElementById('game-footer').style.display = 'none';
                }
            }

            setTimeout(() => lucide.createIcons(), 100);
        }

        async function nextStep(e, step) {
            e.preventDefault();
            
            if (step === 3) {
                // Salvar cadastro
                const success = await saveRegistration();
                if (success) {
                    showScreen(step);
                }
            } else {
                showScreen(step);
            }
        }

        function prevStep(step) {
            showScreen(step);
        }

        async function saveRegistration() {
            const btn = document.querySelector('#form-payment button[type="submit"]');
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = '<div class="loader"></div>';
                btn.disabled = true;
            }

            try {
                const data = {
                    telegram_id: state.telegramId,
                    nome: document.getElementById('nome').value.trim(),
                    cpf: document.getElementById('cpf').value.replace(/\D/g, ''),
                    pix: document.getElementById('pix').value.trim(),
                    telefone: document.getElementById('telefone').value.replace(/\D/g, ''),
                    cidade: document.getElementById('cidade').value.trim() || null,
                    estado: document.getElementById('estado').value || null
                };

                const res = await fetch(`${API_BASE}/api/player/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                
                if (res.ok && result.success) {
                    tg.showAlert('‚úÖ Cadastro realizado com sucesso!');
                    tg.HapticFeedback.notificationOccurred('success');
                    state.registered = true;
                    // Enviar dados para o bot tamb√©m, para manter sincronia se necess√°rio
                    try {
                        tg.sendData(JSON.stringify({...data, action: 'cadastro_usuario'}));
                    } catch (e) {
                         // Ignorar erro de sendData se estivermos no browser ou fora do contexto de bot√£o
                         console.warn("sendData ignorado", e);
                    }
                    return true;
                } else {
                     tg.showAlert('Erro: ' + (result.message || 'Erro desconhecido'));
                     return false;
                }
            } catch (e) {
                console.error(e);
                tg.showAlert('Erro ao realizar cadastro. Verifique sua conex√£o.');
                return false;
            } finally {
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        // ==================== MASKS ====================

        function applyMasks() {
            const cpf = document.getElementById('cpf');
            cpf.addEventListener('input', (e) => {
                let val = e.target.value.replace(/\D/g, '');
                if (val.length <= 11) {
                    val = val.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, (m, p1, p2, p3, p4) => {
                        let r = p1;
                        if (p2) r += '.' + p2;
                        if (p3) r += '.' + p3;
                        if (p4) r += '-' + p4;
                        return r;
                    });
                    e.target.value = val;
                }
                validateCPF(e.target);
            });

            // M√°scara para CPF (login)
            const loginCpf = document.getElementById('login-cpf');
            if (loginCpf) {
                loginCpf.addEventListener('input', (e) => {
                    let val = e.target.value.replace(/\D/g, '');
                    if (val.length <= 11) {
                        val = val.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, (m, p1, p2, p3, p4) => {
                            let r = p1;
                            if (p2) r += '.' + p2;
                            if (p3) r += '.' + p3;
                            if (p4) r += '-' + p4;
                            return r;
                        });
                        e.target.value = val;
                    }
                });
            }

            // M√°scara para telefone (cadastro)
            // M√°scara para telefone (cadastro)
            const tel = document.getElementById('telefone');
            if (tel) {
                tel.addEventListener('input', (e) => {
                    let val = e.target.value.replace(/\D/g, '');
                    if (val.length <= 11) {
                        if (val.length <= 10) {
                            val = val.replace(/(\d{2})(\d{4})(\d{0,4})/, (m, p1, p2, p3) => {
                                return p1 ? '(' + p1 + ') ' + (p2 || '') + (p3 ? '-' + p3 : '') : val;
                            });
                        } else {
                            val = val.replace(/(\d{2})(\d{5})(\d{0,4})/, (m, p1, p2, p3) => {
                                return p1 ? '(' + p1 + ') ' + (p2 || '') + (p3 ? '-' + p3 : '') : val;
                            });
                        }
                        e.target.value = val;
                    }
                });
            }

            // M√°scara para telefone (login)
            const loginTel = document.getElementById('login-telefone');
            if (loginTel) {
                loginTel.addEventListener('input', (e) => {
                    let val = e.target.value.replace(/\D/g, '');
                    if (val.length <= 11) {
                        if (val.length <= 10) {
                            val = val.replace(/(\d{2})(\d{4})(\d{0,4})/, (m, p1, p2, p3) => {
                                return p1 ? '(' + p1 + ') ' + (p2 || '') + (p3 ? '-' + p3 : '') : val;
                            });
                        } else {
                            val = val.replace(/(\d{2})(\d{5})(\d{0,4})/, (m, p1, p2, p3) => {
                                return p1 ? '(' + p1 + ') ' + (p2 || '') + (p3 ? '-' + p3 : '') : val;
                            });
                        }
                        e.target.value = val;
                    }
                });
            }
        }

        // ==================== VALIDATION ====================

        function setupValidation() {
            const pix = document.getElementById('pix');
            pix.addEventListener('input', () => validatePix(pix));
            pix.addEventListener('blur', () => validatePix(pix));
        }

        function validateCPF(input) {
            const cpf = input.value.replace(/\D/g, '');
            const errorEl = document.getElementById('cpf-error');
            const successEl = document.getElementById('cpf-success');
            const helpEl = document.getElementById('cpf-help');

            if (cpf.length === 0) {
                input.classList.remove('error', 'success');
                errorEl.style.display = 'none';
                successEl.style.display = 'none';
                helpEl.style.display = 'flex';
                return false;
            }

            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
                input.classList.add('error');
                input.classList.remove('success');
                errorEl.style.display = 'flex';
                successEl.style.display = 'none';
                helpEl.style.display = 'none';
                return false;
            }

            let soma = 0;
            for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
            let resto = 11 - (soma % 11);
            let digito1 = resto >= 10 ? 0 : resto;

            soma = 0;
            for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
            resto = 11 - (soma % 11);
            let digito2 = resto >= 10 ? 0 : resto;

            const isValid = digito1 === parseInt(cpf.charAt(9)) && digito2 === parseInt(cpf.charAt(10));

            if (isValid) {
                input.classList.remove('error');
                input.classList.add('success');
                errorEl.style.display = 'none';
                successEl.style.display = 'flex';
                helpEl.style.display = 'none';
                return true;
            } else {
                input.classList.add('error');
                input.classList.remove('success');
                errorEl.style.display = 'flex';
                successEl.style.display = 'none';
                helpEl.style.display = 'none';
                return false;
            }
        }

        function validatePix(input) {
            const pix = input.value.trim();
            const errorEl = document.getElementById('pix-error');
            const successEl = document.getElementById('pix-success');
            const helpEl = document.getElementById('pix-help');

            if (pix.length === 0) {
                input.classList.remove('error', 'success');
                errorEl.style.display = 'none';
                successEl.style.display = 'none';
                helpEl.style.display = 'flex';
                return false;
            }

            // Valida√ß√£o b√°sica de PIX
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const phoneRegex = /^\+?[1-9]\d{1,14}$/;
            const cpfRegex = /^\d{11}$/;
            const randomKeyRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

            const cleanPix = pix.replace(/\D/g, '');
            const isValid = emailRegex.test(pix) || 
                          phoneRegex.test(cleanPix) || 
                          cpfRegex.test(cleanPix) || 
                          randomKeyRegex.test(pix) ||
                          pix.length >= 10;

            if (isValid) {
                input.classList.remove('error');
                input.classList.add('success');
                errorEl.style.display = 'none';
                successEl.style.display = 'flex';
                helpEl.style.display = 'none';
                return true;
            } else {
                input.classList.add('error');
                input.classList.remove('success');
                errorEl.style.display = 'flex';
                document.getElementById('pix-error-text').textContent = 'Chave Pix inv√°lida';
                successEl.style.display = 'none';
                helpEl.style.display = 'none';
                return false;
            }
        }

        // ==================== API CALLS ====================

        async function fetchUserData() {
            try {
                const res = await fetch(`${API_BASE}/finance/balance/${state.telegramId}`);
                const data = await res.json();
                state.balance = data.saldo || 0;
                updateGameUI();
            } catch (e) {
                console.error("Erro ao buscar saldo", e);
            }
        }

        async function fetchConfig() {
            try {
                const res = await fetch(`${API_BASE}/api/player/config/bet-price`);
                const data = await res.json();
                state.betPrice = data.preco || 5.00;
                document.getElementById('bet-price').textContent = formatCurrency(state.betPrice);
                
                // Atualizar informa√ß√µes do concurso
                state.concurso.id = data.concurso_id;
                state.concurso.nome = data.concurso_nome || 'Aguardando novo concurso';
                state.concurso.premio = data.premio_total || 0.00;
                state.concurso.dataSorteio = data.data_sorteio_prevista;
                
                updateConcursoInfo();
                updateGameUI();
            } catch (e) {
                console.error("Erro config", e);
            }
        }

        function updateConcursoInfo() {
            const nomeEl = document.getElementById('concurso-nome');
            const idEl = document.getElementById('concurso-id');
            const premioEl = document.getElementById('concurso-premio');
            const dataEl = document.getElementById('concurso-data');
            
            if (nomeEl) nomeEl.textContent = state.concurso.nome;
            
            if (idEl) {
                if (state.concurso.id) {
                    idEl.textContent = `#${state.concurso.id}`;
                    idEl.style.display = 'block';
                } else {
                    idEl.style.display = 'none';
                }
            }
            
            if (premioEl) {
                premioEl.textContent = formatCurrency(state.concurso.premio);
                if (state.concurso.premio > 0) {
                    premioEl.style.color = 'var(--primary)';
                } else {
                    premioEl.style.color = 'var(--text-muted)';
                }
            }
            
            if (dataEl) {
                if (state.concurso.dataSorteio) {
                    const data = new Date(state.concurso.dataSorteio);
                    const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                    dataEl.textContent = data.toLocaleDateString('pt-BR', options);
                    dataEl.style.color = 'var(--text)';
                } else {
                    dataEl.textContent = 'A definir';
                    dataEl.style.color = 'var(--text-muted)';
                }
            }
            
            // Recriar √≠cones ap√≥s atualizar conte√∫do
            setTimeout(() => lucide.createIcons(), 100);
        }

        // ==================== GAME LOGIC ====================

        function renderGrids() {
            const gridWhite = document.getElementById('grid-white');
            const gridRed = document.getElementById('grid-red');

            for (let i = 1; i <= 69; i++) {
                const el = document.createElement('div');
                el.className = 'ball white';
                el.innerText = i;
                el.onclick = () => toggleNumber(i, 'white', el);
                gridWhite.appendChild(el);
            }

            for (let i = 1; i <= 26; i++) {
                const el = document.createElement('div');
                el.className = 'ball red';
                el.innerText = i;
                el.onclick = () => toggleNumber(i, 'red', el);
                gridRed.appendChild(el);
            }
        }

        function toggleNumber(num, type, el) {
            const set = state[type];
            const limit = type === 'white' ? LIMITS.WHITE : LIMITS.RED;

            if (set.has(num)) {
                set.delete(num);
                el.classList.remove('selected');
                tg.HapticFeedback.selectionChanged();
            } else {
                if (set.size < limit) {
                    set.add(num);
                    el.classList.add('selected');
                    tg.HapticFeedback.selectionChanged();
                } else {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
            updateGameUI();
        }

        function gerarSurpresinha() {
            document.querySelectorAll('.ball').forEach(b => b.classList.remove('selected-white', 'selected-red'));
            state.white.clear();
            state.red.clear();

            while(state.white.size < LIMITS.WHITE) {
                let r = Math.floor(Math.random() * 69) + 1;
                state.white.add(r);
            }

            while(state.red.size < LIMITS.RED) {
                let r = Math.floor(Math.random() * 26) + 1;
                state.red.add(r);
            }

            const whiteBalls = document.getElementById('grid-white').children;
            state.white.forEach(num => whiteBalls[num-1].classList.add('selected'));

            const redBalls = document.getElementById('grid-red').children;
            state.red.forEach(num => redBalls[num-1].classList.add('selected'));

            updateGameUI();
            tg.HapticFeedback.notificationOccurred('success');
        }

        function updateGameUI() {
            const cw = document.getElementById('counter-white');
            const cr = document.getElementById('counter-red');
            
            cw.innerText = `${state.white.size}/${LIMITS.WHITE}`;
            cr.innerText = `${state.red.size}/${LIMITS.RED}`;
            
            cw.className = `counter ${state.white.size === LIMITS.WHITE ? 'full' : ''}`;
            cr.className = `counter ${state.red.size === LIMITS.RED ? 'full' : ''}`;

            document.getElementById('user-balance').textContent = formatCurrency(state.balance);

            // Update summary
            const totalSelected = state.white.size + state.red.size;
            document.getElementById('summary-selected').textContent = `${totalSelected}/25`;
            document.getElementById('summary-price').textContent = formatCurrency(state.betPrice);

            // Update action button
            const btn = document.getElementById('btn-action');
            const isFull = state.white.size === LIMITS.WHITE && state.red.size === LIMITS.RED;
            const hasFunds = state.balance >= state.betPrice;

            if (!isFull) {
                btn.textContent = `Selecione ${state.white.size}/${LIMITS.WHITE} Brancas e ${state.red.size}/${LIMITS.RED} Vermelhas`;
                btn.disabled = true;
                btn.classList.remove('ready');
            } else if (!hasFunds) {
                btn.textContent = `Saldo Insuficiente (Faltam ${formatCurrency(state.betPrice - state.balance)})`;
                btn.disabled = false;
                btn.classList.remove('ready');
                btn.onclick = openDepositModal;
            } else {
                btn.textContent = `CONFIRMAR APOSTA (${formatCurrency(state.betPrice)})`;
                btn.disabled = false;
                btn.classList.add('ready');
                btn.onclick = submitBet;
            }
        }

        async function submitBet() {
            if (!validateBetState()) return;

            const btn = document.getElementById('btn-action');
            const originalText = btn.innerText;
            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;

            try {
                const payload = {
                    white: Array.from(state.white),
                    red: Array.from(state.red),
                action: 'aposta_realizada'
            };
            
                tg.sendData(JSON.stringify(payload));
                tg.HapticFeedback.notificationOccurred('success');
                
            } catch (e) {
                console.error(e);
                tg.showAlert("Erro ao processar aposta.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function validateBetState() {
            return state.white.size === LIMITS.WHITE && 
                   state.red.size === LIMITS.RED && 
                   state.balance >= state.betPrice;
        }

        // ==================== DEPOSIT MODAL ====================

        function openDepositModal() {
            document.getElementById('deposit-modal').classList.add('open');
            document.getElementById('step-amount').style.display = 'block';
            document.getElementById('step-pix').style.display = 'none';
            setTimeout(() => lucide.createIcons(), 100);
        }

        function closeDepositModal() {
            document.getElementById('deposit-modal').classList.remove('open');
            clearInterval(state.pixInterval);
        }

        function setAmount(val) {
            document.getElementById('deposit-amount').value = val;
            document.querySelectorAll('.chip').forEach(c => {
                c.classList.toggle('selected', c.textContent.includes(val));
            });
        }

        async function generatePix() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            if (!amount || amount < 5) {
                tg.showAlert("O valor m√≠nimo √© R$ 5,00");
                return;
            }

            const btn = document.querySelector('#step-amount .btn-primary');
            btn.innerHTML = '<div class="loader"></div>';
            
            try {
                const res = await fetch(`${API_BASE}/finance/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: state.telegramId, valor: amount })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showPixScreen(data.pix_code);
                } else {
                    tg.showAlert("Erro ao gerar Pix: " + (data.detail || "Tente novamente."));
                }
            } catch (e) {
                tg.showAlert("Erro de conex√£o.");
            } finally {
                btn.innerHTML = `Gerar Pix <i data-lucide="qrcode" style="width: 20px; height: 20px;"></i>`;
                setTimeout(() => lucide.createIcons(), 100);
            }
        }

        function showPixScreen(code) {
            document.getElementById('step-amount').style.display = 'none';
            document.getElementById('step-pix').style.display = 'block';
            document.getElementById('pix-copy-paste').innerText = code;
            setTimeout(() => lucide.createIcons(), 100);
        }

        function copyPix() {
            const code = document.getElementById('pix-copy-paste').innerText;
            navigator.clipboard.writeText(code);
            tg.showAlert("C√≥digo Pix copiado!");
        }

        // ==================== UTILS ====================

        function formatCurrency(val) {
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // ==================== PERFIL ====================

        let currentTab = 'dados';
        let profileData = null;

        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tab}`);
            });
            
            if (tab === 'dados') {
                loadProfileData();
            } else if (tab === 'apostas') {
                loadBets();
            } else if (tab === 'transacoes') {
                loadTransactions();
            } else if (tab === 'resultados') {
                loadResults();
            }
            
            setTimeout(() => lucide.createIcons(), 100);
        }

        async function loadProfileData() {
            try {
                const res = await fetch(`${API_BASE}/api/player/profile/${state.telegramId}`);
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ detail: res.statusText }));
                    console.error("Erro ao carregar perfil:", errorData);
                    tg.showAlert(`Erro ao carregar dados do perfil: ${errorData.detail || res.statusText}`);
                    return;
                }
                
                const data = await res.json();
                profileData = data;
                
                const container = document.getElementById('profile-data');
                if (!container) {
                    console.error("Elemento profile-data n√£o encontrado");
                    return;
                }
                
                container.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">Nome</span>
                        <span class="info-value">${data.nome || 'N√£o informado'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">CPF</span>
                        <span class="info-value">${data.cpf || 'N√£o informado'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Telefone</span>
                        <span class="info-value">${data.telefone || 'N√£o informado'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Chave PIX</span>
                        <span class="info-value">${data.pix || 'N√£o informado'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cidade</span>
                        <span class="info-value">${data.cidade || 'N√£o informado'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Estado</span>
                        <span class="info-value">${data.estado || 'N√£o informado'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Saldo</span>
                        <span class="info-value" style="color: var(--primary);">${formatCurrency(data.saldo || 0)}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Data de Cadastro</span>
                        <span class="info-value">${data.data_cadastro ? new Date(data.data_cadastro).toLocaleDateString('pt-BR') : 'N√£o informado'}</span>
                    </div>
                `;
            } catch (e) {
                console.error("Erro ao carregar perfil", e);
                tg.showAlert(`Erro ao carregar dados do perfil: ${e.message || 'Erro desconhecido'}`);
            }
        }

        async function loadBets() {
            try {
                const res = await fetch(`${API_BASE}/api/player/my-bets/${state.telegramId}`);
                const data = await res.json();
                
                const container = document.getElementById('bets-list');
                const allBets = [...(data.jogos_ativos || []), ...(data.historico || [])];
                
                if (allBets.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhuma aposta encontrada</p>';
                    return;
                }
                
                container.innerHTML = allBets.map(bet => {
                    const statusClass = bet.status_display === 'GANHOU' ? 'status-won' : 
                                      bet.status_display === 'PERDEU' ? 'status-lost' : 'status-pending';
                    const date = new Date(bet.data_aposta).toLocaleDateString('pt-BR');
                    
                    return `
                        <div class="bet-card">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 700; margin-bottom: 5px;">Aposta #${bet.id}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">${date}</div>
                                </div>
                                <span class="status-badge ${statusClass}">${bet.status_display}</span>
                            </div>
                            <div style="font-size: 0.9rem; margin-bottom: 8px;">
                                <div>Brancos: ${bet.numeros_brancos.slice(0, 10).join(', ')}${bet.numeros_brancos.length > 10 ? '...' : ''}</div>
                                <div>Vermelhos: ${bet.numeros_vermelhos.join(', ')}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: 600;">
                                <span>Valor: ${formatCurrency(bet.valor_pago)}</span>
                                ${bet.valor_premio > 0 ? `<span style="color: var(--success);">Pr√™mio: ${formatCurrency(bet.valor_premio)}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error("Erro ao carregar apostas", e);
            }
        }

        async function loadTransactions() {
            try {
                const res = await fetch(`${API_BASE}/api/player/history/transactions/${state.telegramId}`);
                const data = await res.json();
                
                const container = document.getElementById('transactions-list');
                
                if (!data.transacoes || data.transacoes.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhuma transa√ß√£o encontrada</p>';
                    return;
                }
                
                container.innerHTML = data.transacoes.map(tx => {
                    const isPositive = tx.tipo === 'DEPOSITO' || tx.tipo === 'PREMIO';
                    const date = new Date(tx.data_transacao).toLocaleDateString('pt-BR');
                    const statusClass = tx.status === 'PAGO' ? 'status-won' : 
                                      tx.status === 'PENDENTE' ? 'status-pending' : 'status-lost';
                    
                    return `
                        <div class="transaction-card">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 700; margin-bottom: 5px;">${tx.tipo}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">${date}</div>
                                </div>
                                <span class="status-badge ${statusClass}">${tx.status}</span>
                            </div>
                            <div style="font-weight: 700; font-size: 1.1rem; color: ${isPositive ? 'var(--success)' : 'var(--error)'};">
                                ${isPositive ? '+' : '-'}${formatCurrency(tx.valor)}
                            </div>
                            ${tx.descricao ? `<div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;">${tx.descricao}</div>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error("Erro ao carregar transa√ß√µes", e);
            }
        }

        async function loadResults() {
            try {
                const res = await fetch(`${API_BASE}/api/player/my-bets/${state.telegramId}`);
                const data = await res.json();
                
                const container = document.getElementById('results-list');
                const historico = data.historico || [];
                
                if (historico.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhum resultado dispon√≠vel</p>';
                    return;
                }
                
                container.innerHTML = historico.map(bet => {
                    const statusClass = bet.is_winner ? 'status-won' : 'status-lost';
                    const statusText = bet.is_winner ? 'GANHOU' : 'PERDEU';
                    const date = new Date(bet.data_aposta).toLocaleDateString('pt-BR');
                    
                    return `
                        <div class="result-card">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-weight: 700; margin-bottom: 5px;">Aposta #${bet.id}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">${date}</div>
                                </div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            <div style="background: var(--bg-color); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px;">Seus N√∫meros</div>
                                <div style="font-size: 0.9rem;">
                                    <div>Brancos: ${bet.numeros_brancos.join(', ')}</div>
                                    <div>Vermelhos: ${bet.numeros_vermelhos.join(', ')}</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: 600;">
                                <span>Valor Apostado: ${formatCurrency(bet.valor_pago)}</span>
                                ${bet.valor_premio > 0 ? `<span style="color: var(--success);">Pr√™mio: ${formatCurrency(bet.valor_premio)}</span>` : ''}
                            </div>
                            ${bet.acertos !== undefined ? `<div style="margin-top: 8px; font-size: 0.85rem; color: var(--text-muted);">Acertos: ${bet.acertos}</div>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error("Erro ao carregar resultados", e);
            }
        }

        function handleLogout() {
            if (confirm('Deseja realmente sair da sua conta?')) {
                state.telegramId = null;
                state.registered = false;
                showScreen(0);
                tg.showAlert('Voc√™ foi deslogado com sucesso');
            }
        }

        function openArchiveModal() {
            document.getElementById('archive-modal').classList.add('open');
            setTimeout(() => lucide.createIcons(), 100);
        }

        function closeArchiveModal() {
            document.getElementById('archive-modal').classList.remove('open');
        }

        async function confirmArchive() {
            try {
                const res = await fetch(`${API_BASE}/api/player/profile/archive`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: state.telegramId })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    tg.showAlert('‚úÖ ' + data.message);
                    closeArchiveModal();
                    handleLogout();
                } else {
                    tg.showAlert('‚ùå Erro ao arquivar conta');
                }
            } catch (e) {
                console.error("Erro ao arquivar conta", e);
                tg.showAlert('‚ùå Erro ao arquivar conta');
            }
        }
    </script>
</body>
</html>