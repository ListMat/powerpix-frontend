<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PowerPix</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #0F172A;
            --card-bg: #1E293B;
            --primary: #22C55E; /* Verde Pix */
            --primary-hover: #16A34A;
            --accent: #E11D48; /* Vermelho Powerball */
            --text: #F8FAFC;
            --text-muted: #94A3B8;
            --border: #334155;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding-bottom: 100px; /* Espa칞o para footer */
            user-select: none;
        }

        /* HEADER */
        .header {
            position: sticky;
            top: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .balance-container {
            display: flex;
            flex-direction: column;
        }

        .balance-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .balance-value { font-size: 1.25rem; font-weight: 800; color: var(--primary); }

        .btn-deposit {
            background: linear-gradient(135deg, var(--primary), #166534);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
            transition: transform 0.1s;
        }
        .btn-deposit:active { transform: scale(0.95); }

        /* INFO BAR */
        .info-bar {
            background: var(--card-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border);
        }
        .cost-label { color: var(--text-muted); }
        .cost-value { font-weight: 700; color: var(--text); }

        /* GRID */
        .game-section { padding: 20px; }
        .section-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .counter { font-size: 0.85rem; padding: 4px 10px; border-radius: 20px; background: var(--border); }
        .counter.full { background: var(--primary); color: #000; }

        .grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 30px;
        }

        .ball {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 50%;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Sele칞칚o Branca */
        .ball.white.selected {
            background: var(--text);
            color: var(--bg-color);
            border-color: var(--text);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* Sele칞칚o Vermelha */
        .ball.red.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(225, 29, 72, 0.4);
        }

        /* FOOTER */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            z-index: 90;
        }

        .btn-action {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--border);
            color: var(--text-muted);
        }

        .btn-action.ready {
            background: linear-gradient(135deg, var(--primary), #15803d);
            color: white;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
        }
        
        .btn-action.ready:active { transform: scale(0.98); }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: flex-end; /* Mobile bottom sheet style */
            animation: fadeIn 0.2s;
        }
        .modal-overlay.open { display: flex; }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 500px;
            border-radius: 20px 20px 0 0;
            padding: 25px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        .btn-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 5px; }

        .deposit-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .chip {
            background: var(--bg-color);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 5px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chip:active, .chip.selected {
            border-color: var(--primary);
            background: rgba(34, 197, 94, 0.1);
            color: var(--primary);
        }

        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); }
        .custom-input {
            width: 100%;
            padding: 16px;
            background: var(--bg-color);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 1.2rem;
            font-weight: 700;
            outline: none;
        }
        .custom-input:focus { border-color: var(--primary); }

        .pix-area {
            display: none;
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .pix-code {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            word-break: break-all;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 15px 0;
            border: 1px dashed var(--border);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .status-pending { background: rgba(253, 186, 116, 0.2); color: #fb923c; }
        .status-success { background: rgba(34, 197, 94, 0.2); color: var(--primary); }

        /* Loader */
        .loader {
            width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="header">
        <div class="balance-container">
            <span class="balance-label">Saldo Dispon칤vel</span>
            <span class="balance-value" id="user-balance">R$ --,--</span>
        </div>
        <button class="btn-deposit" onclick="openDepositModal()">
            <i data-lucide="plus-circle" style="width: 18px; height: 18px;"></i>
            DEPOSITAR
        </button>
    </header>

    <!-- INFO BAR -->
    <div class="info-bar">
        <span class="cost-label">Custo da Aposta:</span>
        <span class="cost-value" id="bet-cost">R$ 5,00</span>
    </div>

    <!-- GAME AREA -->
    <main class="game-section">
        <!-- White Numbers -->
        <div class="section-title">
            <span style="display: flex; align-items: center; gap: 8px;">
                <i data-lucide="circle" style="width: 16px; height: 16px;"></i>
                N칰meros (1-69)
            </span>
            <span id="counter-white" class="counter">0/20</span>
        </div>
        <div class="grid" id="grid-white"></div>

        <!-- Red Numbers -->
        <div class="section-title">
            <span style="display: flex; align-items: center; gap: 8px; color: var(--accent);">
                <i data-lucide="circle-dot" style="width: 16px; height: 16px;"></i>
                Powerball (1-26)
            </span>
            <span id="counter-red" class="counter">0/5</span>
        </div>
        <div class="grid" id="grid-red"></div>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
        <button id="btn-action" class="btn-action" onclick="submitBet()" disabled>
            Selecione os N칰meros
        </button>
    </footer>

    <!-- MODAL DE DEP칍SITO -->
    <div class="modal-overlay" id="deposit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" style="display: flex; align-items: center; gap: 10px;">
                    <i data-lucide="wallet" style="width: 24px; height: 24px;"></i>
                    Depositar via Pix
                </div>
                <button class="btn-close" onclick="closeDepositModal()">
                    <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                </button>
            </div>

            <div id="step-amount">
                <div class="input-group">
                    <label>Escolha um valor r치pido:</label>
                    <div class="deposit-options">
                        <div class="chip" onclick="setAmount(5)">R$ 5</div>
                        <div class="chip" onclick="setAmount(10)">R$ 10</div>
                        <div class="chip" onclick="setAmount(20)">R$ 20</div>
                        <div class="chip" onclick="setAmount(35)">R$ 35</div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Ou digite outro valor (Min R$ 5,00):</label>
                    <input type="number" id="deposit-amount" class="custom-input" placeholder="0.00" inputmode="decimal">
                </div>

                <button class="btn-action ready" style="margin-top: 10px;" onclick="generatePix()">
                    Gerar Pix
                </button>
            </div>

            <div id="step-pix" class="pix-area">
                <div class="status-badge status-pending" id="pix-status" style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                    <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                    Aguardando Pagamento...
                </div>
                <p style="font-size: 0.9rem; opacity: 0.8; margin: 0;">Copie o c칩digo abaixo e pague no seu banco:</p>
                
                <div class="pix-code" id="pix-copy-paste" onclick="copyPix()">
                    <!-- C칩digo Pix Aqui -->
                </div>

                <button class="btn-action ready" onclick="copyPix()" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i data-lucide="copy" style="width: 20px; height: 20px;"></i>
                    Copiar C칩digo
                </button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_BASE = window.location.origin; // Usa a origem atual (ngrok ou localhost)
        const tg = window.Telegram.WebApp;
        tg.expand();

        // STATE
        const state = {
            balance: 0,
            betPrice: 5.00,
            white: new Set(),
            red: new Set(),
            telegramId: tg.initDataUnsafe?.user?.id || 123456789, // Fallback para teste
            pixInterval: null
        };

        // CONSTANTS
        const LIMITS = { WHITE: 20, RED: 5 };

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            renderGrids();
            fetchUserData();
            fetchConfig();
            
            // Input listener para valida칞칚o manual
            document.getElementById('deposit-amount').addEventListener('input', (e) => {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            });

            // Inicializar 칤cones Lucide
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

        // ==================== API CALLS ====================

        async function fetchUserData() {
            try {
                // Simula칞칚o de chamada de API para saldo
                const res = await fetch(`${API_BASE}/finance/balance/${state.telegramId}`);
                const data = await res.json();
                state.balance = data.saldo || 0;
                updateUI();
            } catch (e) {
                console.error("Erro ao buscar saldo", e);
                // Fallback para teste visual se API falhar
                // state.balance = 0; 
                updateUI();
            }
        }

        async function fetchConfig() {
            try {
                const res = await fetch(`${API_BASE}/api/player/config/bet-price`);
                const data = await res.json();
                state.betPrice = data.preco || 5.00;
                document.getElementById('bet-cost').textContent = formatCurrency(state.betPrice);
                updateUI();
            } catch (e) {
                console.error("Erro config", e);
            }
        }

        async function submitBet() {
            if (!validateBetState()) return;

            const btn = document.getElementById('btn-action');
            const originalText = btn.innerText;
            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;

            try {
                const payload = {
                    white: Array.from(state.white),
                    red: Array.from(state.red),
                    action: 'aposta_realizada'
                };

                // Envia dados para o Bot via WebApp
                tg.sendData(JSON.stringify(payload));
                
                // Feedback visual antes de fechar (opcional, pois sendData fecha o app geralmente)
                tg.HapticFeedback.notificationOccurred('success');
                
            } catch (e) {
                console.error(e);
                tg.showAlert("Erro ao processar aposta.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function generatePix() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            if (!amount || amount < 5) {
                tg.showAlert("O valor m칤nimo 칠 R$ 5,00");
                return;
            }

            const btn = document.querySelector('#step-amount .btn-action');
            btn.innerHTML = '<div class="loader"></div>';
            
            try {
                const res = await fetch(`${API_BASE}/finance/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: state.telegramId, valor: amount })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showPixScreen(data.pix_code);
                    startPixPolling(data.payment_id); // Assumindo que retorna ID
                } else {
                    tg.showAlert("Erro ao gerar Pix: " + (data.detail || "Tente novamente."));
                }
            } catch (e) {
                tg.showAlert("Erro de conex칚o.");
            } finally {
                btn.innerText = "Gerar Pix";
            }
        }

        // ==================== UI LOGIC ====================

        function renderGrids() {
            const gridWhite = document.getElementById('grid-white');
            const gridRed = document.getElementById('grid-red');

            // Render White (1-69)
            for (let i = 1; i <= 69; i++) {
                const el = document.createElement('div');
                el.className = 'ball white';
                el.innerText = i;
                el.onclick = () => toggleNumber(i, 'white', el);
                gridWhite.appendChild(el);
            }

            // Render Red (1-26)
            for (let i = 1; i <= 26; i++) {
                const el = document.createElement('div');
                el.className = 'ball red';
                el.innerText = i;
                el.onclick = () => toggleNumber(i, 'red', el);
                gridRed.appendChild(el);
            }
        }

        function toggleNumber(num, type, el) {
            const set = state[type];
            const limit = type === 'white' ? LIMITS.WHITE : LIMITS.RED;

            if (set.has(num)) {
                set.delete(num);
                el.classList.remove('selected');
                tg.HapticFeedback.selectionChanged();
            } else {
                if (set.size < limit) {
                    set.add(num);
                    el.classList.add('selected');
                    tg.HapticFeedback.selectionChanged();
                } else {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
            updateUI();
        }

        function updateUI() {
            // Update Counters
            const cw = document.getElementById('counter-white');
            const cr = document.getElementById('counter-red');
            
            cw.innerText = `${state.white.size}/${LIMITS.WHITE}`;
            cr.innerText = `${state.red.size}/${LIMITS.RED}`;
            
            cw.className = `counter ${state.white.size === LIMITS.WHITE ? 'full' : ''}`;
            cr.className = `counter ${state.red.size === LIMITS.RED ? 'full' : ''}`;

            // Update Balance
            document.getElementById('user-balance').textContent = formatCurrency(state.balance);

            // Update Action Button
            const btn = document.getElementById('btn-action');
            const isFull = state.white.size === LIMITS.WHITE && state.red.size === LIMITS.RED;
            const hasFunds = state.balance >= state.betPrice;

            if (!isFull) {
                btn.textContent = `Selecione ${state.white.size}/${LIMITS.WHITE} Brancas e ${state.red.size}/${LIMITS.RED} Vermelhas`;
                btn.disabled = true;
                btn.classList.remove('ready');
            } else if (!hasFunds) {
                btn.textContent = `Saldo Insuficiente (Faltam ${formatCurrency(state.betPrice - state.balance)})`;
                btn.disabled = false; // Permite clicar para depositar (l칩gica opcional)
                btn.classList.remove('ready');
                btn.onclick = openDepositModal; // Redireciona para dep칩sito
            } else {
                btn.textContent = `CONFIRMAR APOSTA (${formatCurrency(state.betPrice)})`;
                btn.disabled = false;
                btn.classList.add('ready');
                btn.onclick = submitBet;
            }
        }

        function validateBetState() {
            return state.white.size === LIMITS.WHITE && 
                   state.red.size === LIMITS.RED && 
                   state.balance >= state.betPrice;
        }

        // ==================== MODAL LOGIC ====================

        function openDepositModal() {
            document.getElementById('deposit-modal').classList.add('open');
            document.getElementById('step-amount').style.display = 'block';
            document.getElementById('step-pix').style.display = 'none';
            setTimeout(() => lucide.createIcons(), 100);
        }

        function closeDepositModal() {
            document.getElementById('deposit-modal').classList.remove('open');
            clearInterval(state.pixInterval);
        }

        function setAmount(val) {
            document.getElementById('deposit-amount').value = val;
            // Highlight selected chip
            document.querySelectorAll('.chip').forEach(c => {
                c.classList.toggle('selected', c.textContent.includes(val));
            });
        }

        function showPixScreen(code) {
            document.getElementById('step-amount').style.display = 'none';
            document.getElementById('step-pix').style.display = 'block';
            document.getElementById('pix-copy-paste').innerText = code;
            setTimeout(() => lucide.createIcons(), 100);
        }

        function copyPix() {
            const code = document.getElementById('pix-copy-paste').innerText;
            navigator.clipboard.writeText(code);
            tg.showAlert("C칩digo Pix copiado!");
        }

        function startPixPolling(paymentId) {
            // Simula칞칚o de Polling (em produ칞칚o, chame endpoint de status)
            // Aqui estamos apenas atualizando o saldo se o usu치rio fechar e abrir
            
            // Exemplo real seria:
            /*
            state.pixInterval = setInterval(async () => {
                const res = await fetch(`${API_BASE}/finance/status/${paymentId}`);
                if (res.paid) {
                    tg.showAlert("Pagamento Confirmado! 游눯");
                    closeDepositModal();
                    fetchUserData();
                }
            }, 3000);
            */
        }

        // ==================== UTILS ====================

        function formatCurrency(val) {
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

    </script>
</body>
</html>